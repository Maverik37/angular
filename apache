<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tabulator ‚Äì Lots / Contextes</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@5.6.3/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f6f8;
    }

    /* üî• WRAPPER DU SCROLL HORIZONTAL */
    #table-wrapper {
      max-width: 1400px;   /* ajuste ici la largeur visible */
      margin: 0 auto;
      overflow-x: auto;    /* scroll horizontal */
      overflow-y: hidden;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    /* emp√™che Tabulator d'√©tirer la largeur */
    .tabulator {
      width: max-content !important;
    }

    /* ajustements visuels l√©gers */
    .tabulator-cell {
      padding: 4px;
    }

    .tabulator-col-title {
      font-size: 12px;
    }

    /* colonne fig√©e un peu diff√©renci√©e */
    .tabulator .tabulator-frozen {
      background: #fafafa;
      z-index: 2;
    }
  </style>
</head>

<body>

  <h2>Suivi Lots / Contextes</h2>

  <div id="table-wrapper">
    <div id="table"></div>
  </div>

  <!-- Tabulator -->
  <script src="https://unpkg.com/tabulator-tables@5.6.3/dist/js/tabulator.min.js"></script>

  <script>
    let table = null;

    // =====================
    // FORMATTER CELLULE (inchang√©)
    // =====================
    function contextCellFormatter(cell) {
      const v = cell.getValue();
      if (!v) return "";

      const tooltip = v.prev_ticket
        ? `Previous mantis : ${v.prev_ticket}`
        : "";

      return `
        <div 
          title="${tooltip}"
          style="
            background:${v.color};
            border-radius:5px;
            padding:4px 6px;
            font-size:11px;
            line-height:1.2;
            text-align:left;
          "
        >
          <div style="font-weight:600; white-space:nowrap;">
            ${v.statut}
          </div>
          <div style="display:flex; justify-content:space-between; gap:6px; white-space:nowrap;">
            <span>v${v.version}</span>
            <span>#${v.ticket}</span>
          </div>
          ${v.date ? `<div style="font-size:10px; opacity:0.85;">${v.date}</div>` : ""}
        </div>
      `;
    }

    // =====================
    // CONSTRUCTION DES COLONNES
    // =====================
    function buildColumns(data) {
      const contexts = Array.from(
        new Set(
          data.flatMap(row =>
            Object.keys(row).filter(k => k !== "lot")
          )
        )
      ).sort();

      const columns = [
        {
          title: "Lot",
          field: "lot",
          frozen: true,
          width: 300,
          headerFilter: "input",
          headerFilterPlaceholder: "Rechercher un lot..."
        }
      ];

      contexts.forEach(ctx => {
        columns.push({
          title: ctx,
          field: ctx,
          width: 160,
          hozAlign: "center",
          formatter: contextCellFormatter
        });
      });

      return columns;
    }

    // =====================
    // INIT TABULATOR (1 FOIS)
    // =====================
    function initTable() {
      table = new Tabulator("#table", {
        layout: "fitData",
        height: "80vh",
        reactiveData: true,
        tooltips: false,
        placeholder: "Aucune donn√©e"
      });
    }

    // =====================
    // CHARGEMENT AJAX
    // =====================
    function loadData() {
      fetch("/api/ton-endpoint") // ‚Üê √† adapter
        .then(res => res.json())
        .then(data => {
          table.setColumns(buildColumns(data));
          table.replaceData(data);
        })
        .catch(err => console.error("Erreur chargement donn√©es", err));
    }

    // =====================
    // BOOTSTRAP
    // =====================
    document.addEventListener("DOMContentLoaded", () => {
      initTable();
      loadData();
    });
  </script>

</body>
</html>
