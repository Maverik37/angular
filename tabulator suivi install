<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi Installation</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome (pour fa-gear comme tes templates) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Tabulator -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        .statut-en-analyse   { background-color:#caf7ff !important; }
        .statut-a-installer  { background-color:#d4fcd1 !important; }
        .statut-termine      { background-color:#d0ffd0 !important; }
    </style>
</head>

<body class="p-3">

<div id="modal_container"></div>

<h3>Suivi des installations</h3>
<div id="table-install"></div>

<script>

    /* ===========================================================
       1) TES DONNÉES (on peut te générer ce JSON côté Django)
    =========================================================== */
    const tableData = DATA_FROM_DJANGO;


    /* ===========================================================
       2) TOOLTIP LOTS (comme ton tooltip délai_ko)
    =========================================================== */
    function lotsTooltip(e, cell) {
        const d = cell.getRow().getData();

        if (!d.su_lots) return false;

        const el = document.createElement("div");
        el.style.padding = "6px 10px";
        el.style.background = "#333";
        el.style.color = "white";
        el.style.borderRadius = "6px";
        el.style.maxWidth = "250px";

        let html = "<b>Lots :</b><br>";

        Object.entries(d.su_lots).forEach(([nom, lot]) => {
            html += `${nom} : ${lot.version}`;
            if (lot.is_new_version) html += " <span style='color:#68f'>[New version]</span>";
            if (lot.is_new_lot) html += " <span style='color:#6f8'>[New lot]</span>";
            html += "<br>";
        });

        el.innerHTML = html;
        return el;
    }


    /* ===========================================================
       3) FILTRES (select list, version moderne)
    =========================================================== */
    function uniqueValues(data, field) {
        const values = [...new Set(data.map(x => x[field]))];
        return values.map(v => ({ label: v, value: v }));
    }


    /* ===========================================================
       4) TABLEAU TABULATOR
    =========================================================== */
    const table = new Tabulator("#table-install", {
        data: tableData,
        layout: "fitColumns",
        reactiveData: true,
        height: "600px",

        rowFormatter: function(row) {
            const d = row.getData();
            if (!d.su_statut) return;

            // couleurs dynamiques
            const name = d.su_statut.toLowerCase();

            if (name.includes("analyse")) row.getElement().classList.add("statut-en-analyse");
            if (name.includes("installer")) row.getElement().classList.add("statut-a-installer");
            if (name.includes("termin")) row.getElement().classList.add("statut-termine");
        },

        columns: [

            /* =====================================================
               Colonne ACTION (avec menu HTMX)
            ===================================================== */
            {
                title: "Action",
                field: "action",
                width: 90,
                hozAlign: "center",
                headerSort: false,
                formatter: function(cell){
                    const d = cell.getRow().getData();
                    return `
                        <div class="dropdown">
                            <button class="btn btn-secondary btn-sm dropdown-toggle"
                                    type="button" data-bs-toggle="dropdown">
                                <i class="fa-solid fa-gear"></i>
                            </button>

                            <ul class="dropdown-menu">

                                <li>
                                    <a class="dropdown-item"
                                       hx-get="/suiviinstall/edit_mantis/${d.id}/"
                                       hx-target="#modal_container"
                                       hx-trigger="click"
                                       hx-swap="innerHTML">
                                        Modifier
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item"
                                       hx-get="/suiviinstall/modal_remove/${d.id}/"
                                       hx-target="#modal_container"
                                       hx-trigger="click"
                                       hx-swap="innerHTML">
                                        Supprimer la ligne
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item"
                                       hx-get="/suiviinstall/edit_lots/${d.id}/"
                                       hx-target="#modal_container"
                                       hx-trigger="click"
                                       hx-swap="innerHTML">
                                        Lots
                                    </a>
                                </li>

                            </ul>
                        </div>
                    `;
                }
            },

            /* ID */
            { title:"ID", field:"id", width:70, sorter:"number" },

            /* Priorité */
            { title:"Priorité", field:"su_priorite", width:90 },

            /* Mantis */
            {
                title:"Mantis",
                field:"su_mantis",
                formatter:"html",
                width:95,
                formatter:function(cell){
                    const v = cell.getValue();
                    if (!v) return "";
                    return `<a href="https://mantisbt-rgcu.cnvats.fr/view.php?id=${v}"
                               target="_blank">${v}</a>`;
                }
            },

            /* Description */
            { title:"Titre", field:"su_description", width:300, headerFilter:"input" },

            /* Type install (avec select filter moderne) */
            {
                title:"Type",
                field:"su_type_installation",
                headerFilter:"list",
                headerFilterParams:{
                    valuesLookup:true,
                }
            },

            /* Contexte (avec select filter moderne) */
            {
                title:"Contexte",
                field:"su_contexte",
                headerFilter:"list",
                headerFilterParams:{
                    valuesLookup:true
                }
            },

            /* Lots (tooltip custom, résumé compact) */
            {
                title:"Lots",
                field:"su_lots",
                hozAlign:"center",
                width:140,
                formatter:function(cell){
                    const d = cell.getRow().getData();
                    return `${d.su_nb_known_lot} / ${d.su_nb_new_version} / ${d.su_nb_new_lot}`;
                },
                tooltip: lotsTooltip
            },

            /* Statut (avec select filter moderne) */
            {
                title:"Statut",
                field:"su_statut",
                headerFilter:"list",
                headerFilterParams:{
                    valuesLookup:true
                }
            },

            /* Commentaire (pas de filtre) */
            {
                title:"Commentaire",
                field:"su_commentary",
                width:250,
                tooltip:true
            },

            /* Réception */
            { title:"Réception", field:"su_reception_date", sorter:"date", width:120 }

        ]
    });

</script>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>