<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tabulator - Suivi Installations</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #table {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>Suivi des Installations</h2>
  <div id="table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <script>
    const tableData = [
      {
        id: 4805,
        description: "QFLIFA - Installation LIFA Unitaire - itération BL_LIFA_5.0.0.06.0",
        priorite: null,
        type_installation: "4",
        contexte: "QFLIFA",
        lots: {
          "LIFA-BDD": { version: "5.0.0.06.0", is_new_version: true, is_new_lot: false },
          "LIFA-IHM": { version: "5.0.0.06.0", is_new_version: true, is_new_lot: false },
          "LIFA-UNITAIRE": { version: "5.0.0.06.0", is_new_version: true, is_new_lot: false }
        },
        statut: "En cours d'analyse",
        reception_date: "2025-12-05",
        taken_date: "2025-12-08 14:47",
        commentaire: "08/12/2025- Analyse en cours",
        nb_known_lot: 0,
        nb_new_version: 3,
        nb_new_lot: 0
      },
      {
        id: 4803,
        description: "[IEAA-INST-0MAJ-x.x.x] - Install 3 - lot S15R150 sur INTG2",
        priorite: null,
        type_installation: "2",
        contexte: "ENVINTG2",
        lots: {
          "Module DSN Inter Régimes": { version: "4.0.2", is_new_version: false, is_new_lot: false }
        },
        statut: "A installer",
        reception_date: "2025-12-05",
        taken_date: "2025-12-05 16:48",
        commentaire: "08/12/2025- Installation en cours\n05/12/2025- Analyse en cours\n08/12/2025- En attente",
        nb_known_lot: 1,
        nb_new_version: 0,
        nb_new_lot: 0
      },
      {
        id: 4785,
        description: "[IEAA-INST-0MAJ-x.x.x] - Install lot S15R160 sur INTG6",
        priorite: null,
        type_installation: "3",
        contexte: "ENVINTG6",
        lots: {
          "F16 - SAMI": { version: "1.3.1", is_new_version: true, is_new_lot: false }
        },
        statut: "Terminé",
        reception_date: "2025-11-27",
        taken_date: "2025-11-28 09:53",
        commentaire: "28/11/2025- Test(s) en cours\n28/11/2025- Installation en cours\n28/11/2025- Analyse en cours\n28/11/2025- En attente",
        nb_known_lot: 0,
        nb_new_version: 1,
        nb_new_lot: 0
      }
    ];

    function lotsFormatter(cell) {
      const data = cell.getRow().getData();
      return `${data.nb_known_lot} / ${data.nb_new_version} / ${data.nb_new_lot}`;
    }

    function lotsTooltip(cell) {
      const lots = cell.getValue();
      let tooltip = "";

      Object.entries(lots).forEach(([name, lot]) => {
        tooltip += `${name} - ${lot.version}`;

        if (lot.is_new_version) tooltip += " [NEW VERSION]";
        if (lot.is_new_lot) tooltip += " [NEW LOT]";

        tooltip += "\n";
      });

      return tooltip;
    }

    const table = new Tabulator("#table", {
      data: tableData,
      layout: "fitColumns",
      responsiveLayout: "collapse",

      columns: [
        { title: "ID", field: "id", headerFilter: "input" },
        { title: "Description", field: "description", headerFilter: "input" },
        { title: "Priorité", field: "priorite", headerFilter: "input" },
        { title: "Type", field: "type_installation", headerFilter: "input" },
        { title: "Contexte", field: "contexte", headerFilter: "input" },

        {
          {
  title: "Lots (C / NV / NL)",
  field: "lots",
  hozAlign: "center",

  formatter: function (cell) {
    const data = cell.getRow().getData();
    return `${data.nb_known_lot} / ${data.nb_new_version} / ${data.nb_new_lot}`;
  },

  tooltip: function (e, cell, onRendered) {
    const rowData = cell.getRow().getData();
    const lots = rowData.lots;

    // ✅ S'il n'y a aucun lot → pas de tooltip
    if (!lots || Object.keys(lots).length === 0) {
      return false;
    }

    // ✅ Création du tooltip DOM (comme ton delais_ko)
    const el = document.createElement("div");
    el.style.padding = "6px 10px";
    el.style.background = "#333";
    el.style.color = "white";
    el.style.borderRadius = "6px";
    el.style.maxWidth = "300px";
    el.style.fontSize = "13px";

    let html = "";

    Object.entries(lots).forEach(([name, lot]) => {
      html += `<b>${name}</b> - ${lot.version}`;

      if (lot.is_new_version) html += " <span style='color:#4CAF50'>[NEW VERSION]</span>";
      if (lot.is_new_lot) html += " <span style='color:#FF9800'>[NEW LOT]</span>";

      html += "<br>";
    });

    el.innerHTML = html;

    return el;
  }
}

        { title: "Statut", field: "statut", headerFilter: "input" },
        { title: "Réception", field: "reception_date", headerFilter: "input" },
        { title: "Prise en charge", field: "taken_date", headerFilter: "input" },

        // Pas de filtre sur commentaire
        { title: "Commentaire", field: "commentaire", headerFilter: false },
      ],
    });
  </script>

</body>
</html>